<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Explorer</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M10 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2z'/%3E%3C/svg%3E">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface2: #1e1e1e;
    --border: #2a2a2a;
    --text: #e4e4e7;
    --text-muted: #71717a;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --danger: #ef4444;
    --success: #22c55e;
  }

  /* Light theme */
  .light-theme {
    --bg: #f5f5f5;
    --surface: #ffffff;
    --surface2: #f0f0f0;
    --border: #e0e0e0;
    --text: #1a1a1a;
    --text-muted: #666666;
  }
  .light-theme .system-bar {
    background: linear-gradient(135deg, #e8eef5 0%, #dde4ed 100%);
  }
  .light-theme .system-bar .sys-icon {
    background: rgba(0,0,0,0.05);
  }
  .light-theme .copy-mini {
    background: rgba(0,0,0,0.06);
  }
  .light-theme .copy-mini:hover {
    background: rgba(0,0,0,0.1);
  }
  .light-theme .selection-bar {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  }

  /* Smooth transitions for theme */
  body, .header, .system-bar, .breadcrumb, .path-bar, .toolbar,
  .file-grid, .file-item, .modal, .context-menu, .toast {
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* Main layout with sidebar */
  .app-layout {
    display: flex;
    min-height: calc(100vh - 57px);
  }

  /* Sidebar */
  .sidebar {
    width: 280px;
    min-width: 280px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.2s ease, min-width 0.2s ease;
  }
  .sidebar.collapsed {
    width: 0;
    min-width: 0;
    border-right: none;
  }
  .sidebar-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
  }
  .sidebar-toggle {
    width: 28px;
    height: 28px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .sidebar-toggle:hover { background: var(--border); color: var(--text); }
  .sidebar-toggle svg { width: 16px; height: 16px; }

  /* Drives section */
  .drives-section {
    padding: 8px;
    border-bottom: 1px solid var(--border);
  }
  .drive-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .drive-item:hover { background: var(--surface2); }
  .drive-item.active {
    background: rgba(59,130,246,0.1);
    color: var(--accent);
  }
  .drive-item .drive-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--surface2);
    border-radius: 6px;
    font-size: 16px;
  }
  .drive-item.active .drive-icon {
    background: rgba(59,130,246,0.15);
  }
  .drive-item .drive-info {
    flex: 1;
    min-width: 0;
  }
  .drive-item .drive-name {
    font-size: 13px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .drive-item .drive-path {
    font-size: 11px;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .drive-item .drive-usage {
    width: 60px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 4px;
  }
  .drive-item .drive-usage-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
  }

  /* Tree section */
  .tree-section {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }
  .tree-section::-webkit-scrollbar { width: 6px; }
  .tree-section::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }
  .tree-section::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  .tree-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    user-select: none;
    transition: background 0.1s;
  }
  .tree-item:hover { background: var(--surface2); }
  .tree-item.active {
    background: rgba(59,130,246,0.1);
    color: var(--accent);
  }
  .tree-item .tree-expand {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .tree-item .tree-expand:hover { background: var(--border); }
  .tree-item .tree-expand svg {
    width: 12px;
    height: 12px;
    transition: transform 0.15s;
  }
  .tree-item .tree-expand.expanded svg { transform: rotate(90deg); }
  .tree-item .tree-expand.no-children { visibility: hidden; }
  .tree-item .tree-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }
  .tree-item .tree-icon svg { width: 18px; height: 18px; }
  .tree-item .tree-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .tree-children {
    margin-left: 20px;
    display: none;
  }
  .tree-children.expanded { display: block; }
  .tree-loading {
    padding: 8px 8px 8px 28px;
    font-size: 12px;
    color: var(--text-muted);
  }

  /* Main content area */
  .main-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  /* Collapsed sidebar toggle button */
  .sidebar-open-btn {
    position: fixed;
    left: 8px;
    top: 72px;
    width: 32px;
    height: 32px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    color: var(--text-muted);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .sidebar-open-btn:hover { background: var(--surface2); color: var(--text); }
  .sidebar-open-btn svg { width: 16px; height: 16px; }
  .sidebar.collapsed ~ .main-content .sidebar-open-btn { display: flex; }

  @media (max-width: 900px) {
    .sidebar { width: 240px; min-width: 240px; }
  }
  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      left: 0;
      top: 57px;
      bottom: 0;
      z-index: 200;
      box-shadow: 4px 0 20px rgba(0,0,0,0.3);
    }
    .sidebar.collapsed { transform: translateX(-100%); }
    .sidebar-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 199;
      display: none;
    }
    .sidebar-backdrop.visible { display: block; }
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header h1 {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: -0.025em;
  }
  .header-actions {
    display: flex;
    gap: 8px;
  }

  /* System info bar */
  .system-bar {
    display: flex;
    align-items: center;
    gap: 24px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    overflow-x: auto;
  }
  .system-bar::-webkit-scrollbar { height: 0; }
  .sys-item {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }
  .sys-item .sys-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    font-size: 16px;
  }
  .sys-item .sys-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .sys-item .sys-label {
    color: var(--text-muted);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .sys-item .sys-value {
    color: var(--text);
    font-weight: 600;
    font-family: 'SF Mono', 'Consolas', monospace;
  }
  .sys-item .sys-value.accent { color: var(--accent); }
  .sys-divider {
    width: 1px;
    height: 32px;
    background: var(--border);
  }
  .disk-bar {
    width: 100px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
  }
  .disk-bar .disk-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 0.3s ease;
  }
  .disk-bar .disk-fill.warning { background: #f59e0b; }
  .disk-bar .disk-fill.danger { background: var(--danger); }
  .copy-mini {
    padding: 4px 8px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 10px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .copy-mini:hover { background: rgba(255,255,255,0.15); color: var(--text); }
  .copy-mini.copied { background: var(--success); color: #fff; }
  .copy-mini svg { width: 12px; height: 12px; }

  /* Password modal */
  .auth-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .auth-overlay.hidden { display: none; }
  .auth-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 100%;
    max-width: 360px;
    text-align: center;
  }
  .auth-box .auth-icon { font-size: 48px; margin-bottom: 16px; }
  .auth-box h2 { font-size: 20px; margin-bottom: 8px; }
  .auth-box p { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }
  .auth-box input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    color: var(--text);
    font-size: 16px;
    text-align: center;
    letter-spacing: 2px;
    margin-bottom: 16px;
  }
  .auth-box input:focus { border-color: var(--accent); outline: none; }
  .auth-box .auth-error {
    color: var(--danger);
    font-size: 13px;
    margin-bottom: 12px;
    display: none;
  }
  .auth-box .auth-error.visible { display: block; }
  .auth-box button {
    width: 100%;
    padding: 12px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .auth-box button:hover { background: var(--accent-hover); }

  /* Search and sort bar */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .search-box {
    flex: 1;
    max-width: 400px;
    position: relative;
  }
  .search-box input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
  }
  .search-box input:focus { border-color: var(--accent); outline: none; }
  .search-box input::placeholder { color: var(--text-muted); }
  .search-box svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    color: var(--text-muted);
  }
  .search-box .clear-search {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }
  .search-box .clear-search:hover { background: var(--border); color: var(--text); }
  .search-box .clear-search.visible { display: flex; }
  .sort-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .sort-controls .sort-label {
    font-size: 12px;
    color: var(--text-muted);
  }
  .sort-btn {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text-muted);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .sort-btn:hover { border-color: var(--accent); color: var(--text); }
  .sort-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .sort-btn svg { width: 14px; height: 14px; }
  .results-count {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: auto;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 12px 24px;
    font-size: 13px;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-wrap: wrap;
  }
  .breadcrumb a {
    color: var(--accent);
    text-decoration: none;
    cursor: pointer;
  }
  .breadcrumb a:hover { text-decoration: underline; }
  .breadcrumb .sep { margin: 0 2px; color: var(--border); }

  /* Path bar */
  .path-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 24px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
    font-size: 13px;
  }
  .path-bar .path-label {
    color: var(--text-muted);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  }
  .path-bar .path-value {
    flex: 1;
    color: var(--text);
    background: var(--surface);
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .path-bar .copy-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  }
  .path-bar .copy-btn:hover {
    background: var(--surface2);
    border-color: var(--accent);
  }
  .path-bar .copy-btn.copied {
    background: var(--success);
    border-color: var(--success);
    color: #fff;
  }
  .path-bar .copy-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn:hover { background: var(--border); }
  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-danger { color: var(--danger); }
  .btn-danger:hover { background: rgba(239,68,68,0.1); }
  .btn-sm { padding: 4px 8px; font-size: 12px; }

  /* Drop zone */
  .dropzone {
    margin: 16px 24px;
    padding: 40px;
    border: 2px dashed var(--border);
    border-radius: 12px;
    text-align: center;
    color: var(--text-muted);
    transition: all 0.2s;
    cursor: pointer;
  }
  .dropzone.active {
    border-color: var(--accent);
    background: rgba(59,130,246,0.05);
    color: var(--accent);
  }
  .dropzone p { margin-top: 8px; font-size: 13px; }
  .dropzone .icon { font-size: 32px; margin-bottom: 8px; }

  /* Upload progress */
  .upload-bar {
    margin: 0 24px 16px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: none;
  }
  .upload-bar.visible { display: block; }
  .upload-bar .progress-track {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  .upload-bar .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s;
    width: 0%;
  }
  .upload-bar .label { font-size: 13px; color: var(--text-muted); }

  /* File grid */
  .file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
    padding: 16px 24px;
  }

  .file-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
  }
  .file-item:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
  }
  .file-item.selected {
    border-color: var(--accent);
    background: rgba(59,130,246,0.08);
    box-shadow: 0 0 0 1px var(--accent), 0 4px 12px rgba(59,130,246,0.15);
  }
  .file-item .checkbox {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 22px;
    height: 22px;
    border: 2px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.15s ease;
    z-index: 10;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .file-item .checkbox svg {
    width: 14px;
    height: 14px;
    stroke: #fff;
    stroke-width: 3;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.15s ease;
  }
  .file-item:hover .checkbox,
  .file-item.selected .checkbox,
  .has-selection .file-item .checkbox {
    opacity: 1;
  }
  .file-item .checkbox:hover {
    border-color: var(--accent);
    transform: scale(1.1);
  }
  .file-item.selected .checkbox {
    background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
    border-color: var(--accent);
  }
  .file-item.selected .checkbox svg {
    opacity: 1;
    transform: scale(1);
  }

  /* Selection toolbar */
  .selection-bar {
    display: none;
    align-items: center;
    gap: 16px;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
    color: #fff;
    font-size: 14px;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    position: sticky;
    top: 57px;
    z-index: 99;
  }
  .selection-bar.visible { display: flex; }
  .selection-bar .count {
    font-weight: 700;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .selection-bar .count::before {
    content: "";
    width: 8px;
    height: 8px;
    background: #fff;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }
  .selection-bar .sel-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }
  .selection-bar .sel-btn svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }
  .selection-bar .sel-btn.ghost {
    background: rgba(255,255,255,0.15);
    color: #fff;
    backdrop-filter: blur(4px);
  }
  .selection-bar .sel-btn.ghost:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
  }
  .selection-bar .sel-btn.primary {
    background: #fff;
    color: var(--accent);
  }
  .selection-bar .sel-btn.primary:hover {
    background: #f0f9ff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .selection-bar .sel-btn.danger {
    background: var(--danger);
    color: #fff;
  }
  .selection-bar .sel-btn.danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239,68,68,0.4);
  }
  .selection-bar .actions {
    display: flex;
    gap: 10px;
    margin-left: auto;
  }
  .selection-bar .left-actions {
    display: flex;
    gap: 8px;
  }
  .selection-bar .divider {
    width: 1px;
    height: 24px;
    background: rgba(255,255,255,0.3);
    margin: 0 4px;
  }
  .file-item .preview {
    width: 100%;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--surface2);
    overflow: hidden;
  }
  .file-item .preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .file-item .preview .icon-large {
    font-size: 40px;
    color: var(--text-muted);
  }
  .file-item .preview .icon-large svg {
    width: 48px;
    height: 48px;
  }
  .file-item .preview.folder-preview {
    background: linear-gradient(135deg, #92400e 0%, #78350f 100%);
    position: relative;
  }
  .file-item .preview.folder-preview::before {
    content: '';
    position: absolute;
    top: 18%;
    left: 12%;
    width: 35%;
    height: 8%;
    background: rgba(251, 191, 36, 0.25);
    border-radius: 4px 4px 0 0;
  }
  .file-item .preview.folder-preview .icon-large svg {
    width: 64px;
    height: 64px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
  }
  .light-theme .file-item .preview.folder-preview {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  }
  .light-theme .file-item .preview.folder-preview::before {
    background: rgba(245, 158, 11, 0.2);
  }
  .light-theme .file-item .preview.folder-preview .icon-large svg {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
  }
  .file-item .info {
    padding: 10px;
  }
  .file-item .info .name {
    font-size: 12px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .file-item .info .meta {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Context menu */
  .context-menu {
    position: fixed;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
    min-width: 180px;
    z-index: 999;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05);
    display: none;
    backdrop-filter: blur(12px);
  }
  .context-menu.visible { display: block; }
  .context-menu button {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 14px;
    border: none;
    background: transparent;
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    text-align: left;
    transition: all 0.1s ease;
  }
  .context-menu button svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: 0.7;
  }
  .context-menu button:hover {
    background: var(--surface2);
  }
  .context-menu button:hover svg { opacity: 1; }
  .context-menu button.danger { color: var(--danger); }
  .context-menu button.danger:hover { background: rgba(239,68,68,0.1); }
  .context-menu button.danger svg { opacity: 1; }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    min-width: 360px;
    max-width: 90vw;
  }
  .modal h3 { font-size: 16px; margin-bottom: 16px; }
  .modal input[type="text"] {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    outline: none;
  }
  .modal input[type="text"]:focus { border-color: var(--accent); }
  .modal .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
  }

  /* Image preview modal */
  .preview-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    cursor: pointer;
  }
  .preview-overlay.visible { display: flex; }
  .preview-overlay img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
  }

  /* Toast */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    padding: 12px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    animation: slideIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(12px);
  }
  .toast.success {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(34,197,94,0.15) 0%, var(--surface) 100%);
  }
  .toast.error {
    border-color: var(--danger);
    background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, var(--surface) 100%);
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-muted);
  }
  .empty .icon { font-size: 48px; margin-bottom: 16px; }
  .empty p { font-size: 14px; }

  /* Loading skeleton */
  .skeleton {
    background: linear-gradient(90deg, var(--surface2) 25%, var(--border) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
  }
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  .skeleton-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .skeleton-item .skeleton-preview {
    width: 100%;
    aspect-ratio: 1;
    background: var(--surface2);
  }
  .skeleton-item .skeleton-info {
    padding: 10px;
  }
  .skeleton-item .skeleton-name {
    height: 14px;
    width: 80%;
    margin-bottom: 6px;
  }
  .skeleton-item .skeleton-meta {
    height: 10px;
    width: 60%;
  }

  /* File item animations */
  .file-item {
    animation: fadeInUp 0.3s ease forwards;
    opacity: 0;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .file-item:nth-child(1) { animation-delay: 0.02s; }
  .file-item:nth-child(2) { animation-delay: 0.04s; }
  .file-item:nth-child(3) { animation-delay: 0.06s; }
  .file-item:nth-child(4) { animation-delay: 0.08s; }
  .file-item:nth-child(5) { animation-delay: 0.1s; }
  .file-item:nth-child(6) { animation-delay: 0.12s; }
  .file-item:nth-child(7) { animation-delay: 0.14s; }
  .file-item:nth-child(8) { animation-delay: 0.16s; }
  .file-item:nth-child(n+9) { animation-delay: 0.18s; }

  /* Drag to move */
  .file-item.dragging {
    opacity: 0.5;
    transform: scale(0.95);
  }
  .file-item.drag-over {
    border-color: var(--success);
    background: rgba(34, 197, 94, 0.1);
    box-shadow: 0 0 0 2px var(--success);
  }

  /* File type icons */
  .file-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .file-icon svg {
    width: 40px;
    height: 40px;
  }

  /* Media preview overlay */
  .media-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    flex-direction: column;
  }
  .media-overlay.visible { display: flex; }
  .media-overlay .media-container {
    max-width: 90vw;
    max-height: 80vh;
    position: relative;
  }
  .media-overlay img {
    max-width: 90vw;
    max-height: 80vh;
    border-radius: 8px;
    object-fit: contain;
  }
  .media-overlay video, .media-overlay audio {
    max-width: 90vw;
    max-height: 80vh;
    border-radius: 8px;
  }
  .media-overlay audio {
    width: 400px;
  }
  .media-overlay .media-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    backdrop-filter: blur(4px);
  }
  .media-overlay .media-nav:hover {
    background: rgba(255,255,255,0.2);
    transform: translateY(-50%) scale(1.1);
  }
  .media-overlay .media-nav.prev { left: 20px; }
  .media-overlay .media-nav.next { right: 20px; }
  .media-overlay .media-nav svg { width: 24px; height: 24px; }
  .media-overlay .media-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .media-overlay .media-close:hover { background: rgba(255,255,255,0.2); }
  .media-overlay .media-info {
    color: #fff;
    margin-top: 16px;
    font-size: 14px;
    text-align: center;
  }
  .media-overlay .media-counter {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 4px;
  }

  /* Text/code file preview in overlay */
  .text-preview {
    background: #1e1e1e;
    border-radius: 8px;
    width: 90vw;
    max-width: 900px;
    max-height: 80vh;
    overflow: auto;
    display: flex;
    position: relative;
  }
  .text-preview .line-numbers {
    padding: 16px 12px 16px 16px;
    text-align: right;
    color: #555;
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', Consolas, 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre;
    user-select: none;
    -webkit-user-select: none;
    border-right: 1px solid #333;
    flex-shrink: 0;
    min-width: 44px;
  }
  .text-preview pre {
    margin: 0;
    padding: 16px;
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', Consolas, 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    color: #d4d4d4;
    white-space: pre-wrap;
    word-break: break-all;
    flex: 1;
    min-width: 0;
  }
  .text-preview::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  .text-preview::-webkit-scrollbar-track {
    background: #1e1e1e;
  }
  .text-preview::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
  }
  .text-preview::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  .text-preview .loading-text {
    color: #888;
    padding: 40px;
    font-family: inherit;
    font-size: 14px;
  }

  .light-theme .text-preview {
    background: #fafafa;
  }
  .light-theme .text-preview .line-numbers {
    color: #999;
    border-right-color: #ddd;
  }
  .light-theme .text-preview pre {
    color: #333;
  }
  .light-theme .text-preview::-webkit-scrollbar-track {
    background: #fafafa;
  }
  .light-theme .text-preview::-webkit-scrollbar-thumb {
    background: #ccc;
  }
  .light-theme .text-preview::-webkit-scrollbar-thumb:hover {
    background: #aaa;
  }

  .media-overlay .media-download {
    position: absolute;
    top: 20px;
    right: 72px;
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .media-overlay .media-download:hover { background: rgba(255,255,255,0.2); }
  .media-overlay .media-download svg { width: 18px; height: 18px; }

  /* Theme toggle */
  .theme-toggle {
    width: 36px;
    height: 36px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface2);
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .theme-toggle:hover { background: var(--border); }
  .theme-toggle svg { width: 18px; height: 18px; }

  /* Responsive */
  @media (max-width: 900px) {
    .system-bar { gap: 16px; padding: 10px 16px; }
    .sys-item .sys-icon { display: none; }
    .system-bar .sys-divider:nth-child(10) { display: none; }
    .system-bar .sys-item:nth-child(11) { display: none; }
  }
  @media (max-width: 640px) {
    .file-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; padding: 12px; }
    .header { padding: 12px 16px; }
    .header h1 { font-size: 16px; }
    .system-bar { gap: 12px; }
    .sys-item .sys-content { gap: 1px; }
    .sys-item .sys-label { font-size: 9px; }
    .sys-item .sys-value { font-size: 11px; }
    .system-bar .sys-divider:nth-child(8),
    .system-bar .sys-item:nth-child(9) { display: none; }
    .breadcrumb { padding: 10px 16px; }
    .path-bar { padding: 8px 16px; gap: 8px; }
    .path-bar .path-label { display: none; }
    .path-bar .path-value { font-size: 11px; padding: 6px 10px; }
    .path-bar .copy-btn { padding: 6px 10px; font-size: 11px; }
    .toolbar { padding: 10px 16px; gap: 8px; flex-wrap: wrap; }
    .search-box { max-width: none; order: 1; flex-basis: 100%; }
    .sort-controls { order: 2; }
    .sort-controls .sort-label { display: none; }
    .sort-btn { padding: 6px 10px; font-size: 11px; }
    .results-count { order: 3; margin-left: 0; }
    .dropzone { margin: 12px; padding: 24px; }
    .selection-bar {
      padding: 10px 16px;
      gap: 10px;
      flex-wrap: wrap;
      top: 53px;
    }
    .selection-bar .count { font-size: 13px; }
    .selection-bar .sel-btn { padding: 6px 12px; font-size: 12px; }
    .selection-bar .left-actions { gap: 6px; }
    .selection-bar .actions { gap: 6px; }
    .selection-bar .divider { display: none; }
  }
</style>
</head>
<body>

<!-- Setup overlay (first-run) -->
<div class="auth-overlay" id="setupOverlay">
  <div class="auth-box" style="max-width: 420px;">
    <div class="auth-icon">&#9881;</div>
    <h2>Welcome to File Explorer</h2>
    <p>Set up your file sharing server</p>
    <div class="auth-error" id="setupError">Setup failed</div>
    <input type="password" id="setupPassword" placeholder="Choose a password" style="margin-bottom: 12px;" onkeydown="if(event.key==='Enter')document.getElementById('setupConfirmPassword').focus()">
    <input type="password" id="setupConfirmPassword" placeholder="Confirm password" style="margin-bottom: 12px;" onkeydown="if(event.key==='Enter')document.getElementById('setupDir').focus()">
    <input type="text" id="setupDir" placeholder="Shared directory (e.g. ~/shared)" style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px;margin-bottom:12px;text-align:center;" onkeydown="if(event.key==='Enter')submitSetup()">
    <label style="display:flex;align-items:center;gap:8px;justify-content:center;font-size:13px;color:var(--text-muted);margin-bottom:12px;cursor:pointer;">
      <input type="checkbox" id="setupFilesystem" style="width:16px;height:16px;accent-color:var(--accent);">
      Allow full filesystem browsing
    </label>
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:6px;">Session expiration</label>
      <select id="setupTokenExpiry" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px;text-align:center;appearance:auto;">
        <option value="0">Never (recommended for private networks)</option>
        <option value="86400000">1 day</option>
        <option value="604800000">7 days</option>
        <option value="2592000000">30 days</option>
      </select>
    </div>
    <button onclick="submitSetup()">Complete Setup</button>
  </div>
</div>

<!-- Auth overlay -->
<div class="auth-overlay hidden" id="authOverlay">
  <div class="auth-box">
    <div class="auth-icon">&#128274;</div>
    <h2>File Explorer</h2>
    <p>Enter password to access files</p>
    <div class="auth-error" id="authError">Incorrect password</div>
    <input type="password" id="authPassword" placeholder="Password" onkeydown="if(event.key==='Enter')submitAuth()">
    <button onclick="submitAuth()">Unlock</button>
  </div>
</div>

<!-- Settings modal -->
<div class="modal-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="min-width:400px;max-width:480px;">
    <h3>Settings</h3>
    <div id="settingsError" style="display:none;color:var(--danger);font-size:13px;margin-bottom:12px;">Error</div>
    <div id="settingsSuccess" style="display:none;color:var(--success);font-size:13px;margin-bottom:12px;">Settings saved</div>

    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px;">Shared Directory</label>
      <input type="text" id="settingsDir" placeholder="/path/to/shared" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;">
    </div>

    <div style="margin-bottom:16px;">
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-muted);cursor:pointer;">
        <input type="checkbox" id="settingsFilesystem" style="width:16px;height:16px;accent-color:var(--accent);">
        Allow full filesystem browsing
      </label>
    </div>

    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px;">Session Expiration</label>
      <select id="settingsTokenExpiry" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;appearance:auto;">
        <option value="0">Never</option>
        <option value="86400000">1 day</option>
        <option value="604800000">7 days</option>
        <option value="2592000000">30 days</option>
      </select>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">

    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px;">Current Password <span style="color:var(--danger);">*required to save</span></label>
      <input type="password" id="settingsCurrentPassword" placeholder="Current password" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;">
    </div>

    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px;">New Password <span style="font-weight:normal;">(leave blank to keep current)</span></label>
      <input type="password" id="settingsNewPassword" placeholder="New password" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;margin-bottom:8px;">
      <input type="password" id="settingsConfirmPassword" placeholder="Confirm new password" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;">
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
    </div>
  </div>
</div>

<div class="header">
  <h1>File Explorer</h1>
  <div class="header-actions">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
      <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>
    <button class="btn" onclick="logout()" title="Log out">&#x2190; Logout</button>
    <button class="btn" onclick="openSettings()">&#9881; Settings</button>
    <button class="btn" onclick="toggleSystemBar()">&#9432; Info</button>
    <button class="btn" onclick="createFolder()">+ Folder</button>
    <button class="btn btn-primary" onclick="fileInput.click()">Upload</button>
    <input type="file" id="fileInput" multiple hidden onchange="uploadFiles(this.files)">
  </div>
</div>

<div class="app-layout">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span>Explorer</span>
      <button class="sidebar-toggle" onclick="toggleSidebar()" title="Hide sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
      </button>
    </div>
    <div class="drives-section" id="drivesSection">
      <!-- Drives will be loaded here -->
    </div>
    <div class="tree-section" id="treeSection">
      <!-- Folder tree will be loaded here -->
    </div>
  </div>
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

  <!-- Main content -->
  <div class="main-content">
    <button class="sidebar-open-btn" onclick="toggleSidebar()" title="Show sidebar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
    </button>

<div class="system-bar" id="systemBar">
  <div class="sys-item">
    <div class="sys-icon">&#128421;</div>
    <div class="sys-content">
      <span class="sys-label">Hostname</span>
      <span class="sys-value" id="sysHostname">-</span>
    </div>
  </div>
  <div class="sys-divider"></div>
  <div class="sys-item">
    <div class="sys-icon">&#127760;</div>
    <div class="sys-content">
      <span class="sys-label">IP Address</span>
      <span class="sys-value" id="sysIp">-</span>
    </div>
    <button class="copy-mini" onclick="copyToClip(this, document.getElementById('sysIp').textContent)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
    </button>
  </div>
  <div class="sys-divider"></div>
  <div class="sys-item">
    <div class="sys-icon">&#128279;</div>
    <div class="sys-content">
      <span class="sys-label">Access URL</span>
      <span class="sys-value accent" id="sysUrl">-</span>
    </div>
    <button class="copy-mini" onclick="copyToClip(this, document.getElementById('sysUrl').textContent)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
    </button>
  </div>
  <div class="sys-divider"></div>
  <div class="sys-item">
    <div class="sys-icon">&#128190;</div>
    <div class="sys-content">
      <span class="sys-label">Disk Usage</span>
      <span class="sys-value" id="sysDisk">-</span>
      <div class="disk-bar">
        <div class="disk-fill" id="diskFill" style="width: 0%"></div>
      </div>
    </div>
  </div>
  <div class="sys-divider"></div>
  <div class="sys-item">
    <div class="sys-icon">&#128194;</div>
    <div class="sys-content">
      <span class="sys-label">Selected Path</span>
      <span class="sys-value" id="sysFilePath" style="font-size: 11px;">-</span>
    </div>
    <button class="copy-mini" onclick="copyToClip(this, document.getElementById('sysFilePath').textContent)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
    </button>
  </div>
</div>

<div class="breadcrumb" id="breadcrumb"></div>

<div class="path-bar">
  <span class="path-label">Full Path</span>
  <div class="path-value" id="fullPath">-</div>
  <button class="copy-btn" id="copyPathBtn" onclick="copyPath()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
    </svg>
    Copy
  </button>
</div>

<!-- Search and sort toolbar -->
<div class="toolbar">
  <div class="search-box">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    <input type="text" id="searchInput" placeholder="Search files..." oninput="handleSearch()">
    <button class="clear-search" id="clearSearch" onclick="clearSearch()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="sort-controls">
    <span class="sort-label">Sort:</span>
    <button class="sort-btn active" data-sort="name" onclick="setSort('name')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h12M3 18h6"/></svg>
      Name
    </button>
    <button class="sort-btn" data-sort="date" onclick="setSort('date')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Date
    </button>
    <button class="sort-btn" data-sort="size" onclick="setSort('size')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="m7 10 5 5 5-5"/><path d="M12 15V3"/></svg>
      Size
    </button>
  </div>
  <span class="results-count" id="resultsCount"></span>
</div>

<div class="selection-bar" id="selectionBar">
  <span class="count"><span id="selectionCount">0</span> selected</span>
  <div class="left-actions">
    <button class="sel-btn ghost" onclick="selectAll()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
      </svg>
      Select All
    </button>
    <button class="sel-btn ghost" onclick="clearSelection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
      Clear
    </button>
  </div>
  <div class="divider"></div>
  <div class="actions">
    <button class="sel-btn primary" onclick="downloadSelected()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Download
    </button>
    <button class="sel-btn danger" onclick="deleteSelected()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
      </svg>
      Delete
    </button>
  </div>
</div>

<div class="dropzone" id="dropzone"
     ondragover="event.preventDefault(); this.classList.add('active')"
     ondragleave="this.classList.remove('active')"
     ondrop="handleDrop(event)"
     onclick="fileInput.click()">
  <div class="icon">&#128230;</div>
  <strong>Drop files here or click to upload</strong>
  <p>Files will be saved to <span id="dropPath"></span></p>
</div>

<div class="upload-bar" id="uploadBar">
  <div class="label" id="uploadLabel">Uploading...</div>
  <div class="progress-track">
    <div class="progress-fill" id="uploadProgress"></div>
  </div>
</div>

<div class="file-grid" id="fileGrid"></div>
<div class="empty" id="emptyState" style="display:none">
  <div class="icon">&#128194;</div>
  <p>This folder is empty</p>
</div>

<!-- Context menu -->
<div class="context-menu" id="contextMenu">
  <button id="ctxDownload" onclick="downloadItem()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    <span>Download</span>
  </button>
  <button id="ctxCopyPath" onclick="copyItemPath()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
    <span>Copy Path</span>
  </button>
  <button id="ctxRename" onclick="renameItem()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
    <span>Rename</span>
  </button>
  <button id="ctxDelete" class="danger" onclick="deleteItem()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
    <span>Delete</span>
  </button>
</div>

<!-- Rename modal -->
<div class="modal-overlay" id="renameModal">
  <div class="modal">
    <h3>Rename</h3>
    <input type="text" id="renameInput" onkeydown="if(event.key==='Enter')confirmRename()">
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('renameModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<!-- Folder modal -->
<div class="modal-overlay" id="folderModal">
  <div class="modal">
    <h3>New Folder</h3>
    <input type="text" id="folderInput" placeholder="Folder name" onkeydown="if(event.key==='Enter')confirmFolder()">
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('folderModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmFolder()">Create</button>
    </div>
  </div>
</div>

<!-- Media preview (images, video, audio) -->
<div class="media-overlay" id="mediaOverlay" onclick="if(event.target === this) closeMedia()">
  <button class="media-close" onclick="closeMedia()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
  </button>
  <button class="media-download" id="mediaDownload" onclick="downloadCurrentPreview()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  </button>
  <button class="media-nav prev" onclick="prevMedia()" id="mediaPrev">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
  </button>
  <button class="media-nav next" onclick="nextMedia()" id="mediaNext">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
  </button>
  <div class="media-container" id="mediaContainer"></div>
  <div class="media-info" id="mediaInfo"></div>
  <div class="media-counter" id="mediaCounter"></div>
</div>

  </div><!-- end main-content -->
</div><!-- end app-layout -->

<!-- Toasts -->
<div class="toast-container" id="toasts"></div>

<script>
let currentPath = "";
let defaultDir = "";
let contextTarget = null;
let currentItems = [];
let filteredItems = [];
let selectedPaths = new Set();
let lastSelectedIndex = -1;
let authToken = localStorage.getItem("authToken") || "";
let currentSort = { field: "name", asc: true };
let searchQuery = "";
let drives = [];
let expandedPaths = new Set();
let sidebarCollapsed = localStorage.getItem("sidebarCollapsed") === "true";

// Setup functions
async function checkSetupNeeded() {
  try {
    const res = await fetch("/api/status");
    const data = await res.json();
    return data.needsSetup;
  } catch {
    return false;
  }
}

async function submitSetup() {
  const password = document.getElementById("setupPassword").value;
  const confirmPassword = document.getElementById("setupConfirmPassword").value;
  const sharedDir = document.getElementById("setupDir").value.trim();
  const allowFullFilesystem = document.getElementById("setupFilesystem").checked;
  const tokenExpiryMs = parseInt(document.getElementById("setupTokenExpiry").value, 10) || 0;
  const errorEl = document.getElementById("setupError");

  if (!password) {
    errorEl.textContent = "Password is required";
    errorEl.classList.add("visible");
    return;
  }

  if (password !== confirmPassword) {
    errorEl.textContent = "Passwords do not match";
    errorEl.classList.add("visible");
    return;
  }

  try {
    const body = { password, tokenExpiryMs };
    if (sharedDir) body.sharedDir = sharedDir;
    body.allowFullFilesystem = allowFullFilesystem;

    const res = await fetch("/api/setup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      const data = await res.json();
      authToken = data.token;
      localStorage.setItem("authToken", authToken);
      document.getElementById("setupOverlay").classList.add("hidden");
      initApp();
    } else {
      const err = await res.json();
      errorEl.textContent = err.error || "Setup failed";
      errorEl.classList.add("visible");
    }
  } catch (err) {
    errorEl.textContent = "Connection error";
    errorEl.classList.add("visible");
  }
}

// Auth functions
async function submitAuth() {
  const password = document.getElementById("authPassword").value;
  const errorEl = document.getElementById("authError");

  try {
    const res = await fetch("/api/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password })
    });

    if (res.ok) {
      const data = await res.json();
      authToken = data.token;
      localStorage.setItem("authToken", authToken);
      document.getElementById("authOverlay").classList.add("hidden");
      initApp();
    } else {
      const err = await res.json().catch(() => null);
      errorEl.textContent = (err && err.error) || "Incorrect password";
      errorEl.classList.add("visible");
      document.getElementById("authPassword").value = "";
      document.getElementById("authPassword").focus();
    }
  } catch (err) {
    errorEl.textContent = "Connection error";
    errorEl.classList.add("visible");
  }
}

function authHeaders() {
  return { "X-Auth-Token": authToken };
}

// Settings functions
async function openSettings() {
  const errorEl = document.getElementById("settingsError");
  const successEl = document.getElementById("settingsSuccess");
  errorEl.style.display = "none";
  successEl.style.display = "none";
  document.getElementById("settingsCurrentPassword").value = "";
  document.getElementById("settingsNewPassword").value = "";
  document.getElementById("settingsConfirmPassword").value = "";

  try {
    const res = await fetch("/api/settings", { headers: authHeaders() });
    if (res.ok) {
      const data = await res.json();
      document.getElementById("settingsDir").value = data.sharedDir || "";
      document.getElementById("settingsFilesystem").checked = !!data.allowFullFilesystem;
      document.getElementById("settingsTokenExpiry").value = String(data.tokenExpiryMs || 0);
    }
  } catch {}

  document.getElementById("settingsOverlay").classList.add("visible");
}

function closeSettings() {
  document.getElementById("settingsOverlay").classList.remove("visible");
}

function showSettingsError(msg) {
  const el = document.getElementById("settingsError");
  el.textContent = msg;
  el.style.display = "block";
}

async function saveSettings() {
  const errorEl = document.getElementById("settingsError");
  const successEl = document.getElementById("settingsSuccess");
  errorEl.style.display = "none";
  successEl.style.display = "none";

  const currentPassword = document.getElementById("settingsCurrentPassword").value;
  if (!currentPassword) {
    showSettingsError("Current password is required");
    return;
  }

  const newPassword = document.getElementById("settingsNewPassword").value;
  const confirmPassword = document.getElementById("settingsConfirmPassword").value;
  if (newPassword && newPassword !== confirmPassword) {
    showSettingsError("New passwords do not match");
    return;
  }

  const body = {
    currentPassword,
    sharedDir: document.getElementById("settingsDir").value.trim(),
    allowFullFilesystem: document.getElementById("settingsFilesystem").checked,
    tokenExpiryMs: parseInt(document.getElementById("settingsTokenExpiry").value, 10) || 0,
  };

  if (newPassword) body.newPassword = newPassword;

  try {
    const res = await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(body),
    });

    if (res.ok) {
      const data = await res.json();
      if (data.token) {
        authToken = data.token;
        localStorage.setItem("authToken", authToken);
      }
      successEl.style.display = "block";
      toast("Settings saved", "success");
      document.getElementById("settingsCurrentPassword").value = "";
      document.getElementById("settingsNewPassword").value = "";
      document.getElementById("settingsConfirmPassword").value = "";
      // Reload sidebar drives and file listing to reflect new shared dir
      loadDrives();
      loadFiles(currentPath);
    } else {
      const err = await res.json();
      showSettingsError(err.error || "Failed to save settings");
    }
  } catch {
    showSettingsError("Connection error");
  }
}

function checkAuth() {
  if (authToken) {
    document.getElementById("authOverlay").classList.add("hidden");
    return true;
  }
  document.getElementById("authOverlay").classList.remove("hidden");
  document.getElementById("authPassword").focus();
  return false;
}

function logout() {
  authToken = "";
  localStorage.removeItem("authToken");
  checkAuth();
}

// Search functions
function handleSearch() {
  searchQuery = document.getElementById("searchInput").value.toLowerCase();
  document.getElementById("clearSearch").classList.toggle("visible", searchQuery.length > 0);
  applyFilterAndSort();
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  searchQuery = "";
  document.getElementById("clearSearch").classList.remove("visible");
  applyFilterAndSort();
}

// Sort functions
function setSort(field) {
  if (currentSort.field === field) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort.field = field;
    currentSort.asc = field === "name";
  }

  document.querySelectorAll(".sort-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.sort === field);
  });

  applyFilterAndSort();
}

function applyFilterAndSort() {
  // Filter
  filteredItems = currentItems.filter(item => {
    if (!searchQuery) return true;
    return item.name.toLowerCase().includes(searchQuery);
  });

  // Sort (folders first, then by field)
  filteredItems.sort((a, b) => {
    if (a.isDirectory !== b.isDirectory) return a.isDirectory ? -1 : 1;

    let cmp = 0;
    switch (currentSort.field) {
      case "name":
        cmp = a.name.localeCompare(b.name);
        break;
      case "date":
        cmp = new Date(b.modified) - new Date(a.modified);
        break;
      case "size":
        cmp = b.size - a.size;
        break;
    }
    return currentSort.asc ? cmp : -cmp;
  });

  // Update results count
  const countEl = document.getElementById("resultsCount");
  if (searchQuery) {
    countEl.textContent = `${filteredItems.length} of ${currentItems.length} items`;
  } else {
    countEl.textContent = `${currentItems.length} items`;
  }

  renderGrid(filteredItems);
}

const IMAGE_EXTS = new Set(["jpg","jpeg","png","gif","webp","svg","bmp","ico"]);
const VIDEO_EXTS = new Set(["mp4","webm","mov","avi","mkv"]);
const AUDIO_EXTS = new Set(["mp3","wav","ogg","flac","aac"]);
const DOC_EXTS = new Set(["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","md","csv","json","yaml","yml"]);
const CODE_EXTS = new Set(["js","ts","jsx","tsx","py","rb","go","rs","java","c","cpp","h","css","scss","html","php","sh","sql"]);
const ARCHIVE_EXTS = new Set(["zip","tar","gz","rar","7z","bz2"]);
const TEXT_EXTS = new Set([
  "txt","md","json","xml","csv","log","yaml","yml","toml","ini","conf","cfg","env",
  "js","ts","jsx","tsx","py","rb","go","rs","java","c","cpp","h","css","scss","html","php","sh","sql",
  "makefile","dockerfile","gitignore","editorconfig","htaccess","bat","ps1","lua","r","swift","kt","scala",
  "pl","pm","tcl","vim","asm","s","cmake","gradle","properties","srt","vtt","rst","tex","bib"
]);
const TEXT_PREVIEW_MAX_SIZE = 1024 * 1024; // 1 MB

let mediaItems = [];
let currentMediaIndex = 0;
let isDarkTheme = true;
let draggedItem = null;

// Theme toggle
function toggleTheme() {
  isDarkTheme = !isDarkTheme;
  document.body.classList.toggle("light-theme", !isDarkTheme);
  localStorage.setItem("theme", isDarkTheme ? "dark" : "light");
  updateThemeIcon();
}

function updateThemeIcon() {
  const icon = document.getElementById("themeIcon");
  if (isDarkTheme) {
    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  } else {
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  }
}

// Media preview functions
function isMedia(name) {
  const ext = getExt(name);
  return IMAGE_EXTS.has(ext) || VIDEO_EXTS.has(ext) || AUDIO_EXTS.has(ext);
}

function isVideo(name) {
  return VIDEO_EXTS.has(getExt(name));
}

function isAudio(name) {
  return AUDIO_EXTS.has(getExt(name));
}

function isTextFile(name) {
  return TEXT_EXTS.has(getExt(name));
}

function buildMediaItems() {
  mediaItems = filteredItems.filter(item => !item.isDirectory && isMedia(item.name));
}

function openMedia(index) {
  buildMediaItems();
  const item = filteredItems[index];
  if (!item || item.isDirectory) return;

  const mediaIndex = mediaItems.findIndex(m => m.path === item.path);
  if (mediaIndex === -1) return;

  currentMediaIndex = mediaIndex;
  showMediaItem(currentMediaIndex);
  document.getElementById("mediaOverlay").classList.add("visible");
  document.body.style.overflow = "hidden";
}

function showMediaItem(index) {
  const item = mediaItems[index];
  if (!item) return;

  const container = document.getElementById("mediaContainer");
  // Remove leading slash from absolute path for URL construction
  const urlPath = item.path.startsWith('/') ? item.path.slice(1) : item.path;
  const url = "/files/" + encodeURIComponent(urlPath).replace(/%2F/g, "/") + "?token=" + authToken;

  // Clear container
  container.textContent = "";

  if (isVideo(item.name)) {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.autoplay = true;
    container.appendChild(video);
  } else if (isAudio(item.name)) {
    const audio = document.createElement("audio");
    audio.src = url;
    audio.controls = true;
    audio.autoplay = true;
    container.appendChild(audio);
  } else {
    const img = document.createElement("img");
    img.src = url;
    img.alt = item.name;
    container.appendChild(img);
  }

  document.getElementById("mediaInfo").textContent = item.name;
  document.getElementById("mediaCounter").textContent = (index + 1) + " / " + mediaItems.length;

  document.getElementById("mediaPrev").style.display = mediaItems.length > 1 ? "flex" : "none";
  document.getElementById("mediaNext").style.display = mediaItems.length > 1 ? "flex" : "none";
}

function closeMedia() {
  document.getElementById("mediaOverlay").classList.remove("visible");
  document.getElementById("mediaContainer").textContent = "";
  document.body.style.overflow = "";
  // Clean up text preview state
  currentTextItem = null;
  document.getElementById("mediaDownload").style.display = "none";
}

let currentTextItem = null;

function openTextPreview(index) {
  const item = filteredItems[index];
  if (!item || item.isDirectory) return;

  // If file is too large, fall back to download
  if (item.size > TEXT_PREVIEW_MAX_SIZE) {
    window.open("/api/download?path=" + encodeURIComponent(item.path) + "&token=" + authToken);
    return;
  }

  currentTextItem = item;
  const overlay = document.getElementById("mediaOverlay");
  const container = document.getElementById("mediaContainer");

  // Show loading state
  container.textContent = "";
  const loadingDiv = document.createElement("div");
  loadingDiv.className = "text-preview";
  const loadingText = document.createElement("div");
  loadingText.className = "loading-text";
  loadingText.textContent = "Loading...";
  loadingDiv.appendChild(loadingText);
  container.appendChild(loadingDiv);

  // Show overlay, hide nav arrows, show download button
  overlay.classList.add("visible");
  document.body.style.overflow = "hidden";
  document.getElementById("mediaPrev").style.display = "none";
  document.getElementById("mediaNext").style.display = "none";
  document.getElementById("mediaDownload").style.display = "flex";

  document.getElementById("mediaInfo").textContent = item.name;
  document.getElementById("mediaCounter").textContent = formatSize(item.size);

  // Fetch file content
  const urlPath = item.path.startsWith('/') ? item.path.slice(1) : item.path;
  const url = "/files/" + encodeURIComponent(urlPath).replace(/%2F/g, "/") + "?token=" + authToken;

  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error("Failed to load file");
      return res.text();
    })
    .then(text => {
      if (currentTextItem !== item) return; // closed or changed
      container.textContent = "";

      const wrapper = document.createElement("div");
      wrapper.className = "text-preview";

      const lines = text.split('\n');
      const lineNums = document.createElement("div");
      lineNums.className = "line-numbers";
      lineNums.textContent = lines.map((_, i) => i + 1).join('\n');

      const pre = document.createElement("pre");
      pre.textContent = text;

      wrapper.appendChild(lineNums);
      wrapper.appendChild(pre);
      container.appendChild(wrapper);
    })
    .catch(() => {
      if (currentTextItem !== item) return;
      container.textContent = "";
      const errDiv = document.createElement("div");
      errDiv.className = "text-preview";
      const errText = document.createElement("div");
      errText.className = "loading-text";
      errText.textContent = "Failed to load file";
      errDiv.appendChild(errText);
      container.appendChild(errDiv);
    });
}

function downloadCurrentPreview() {
  if (!currentTextItem) return;
  window.open("/api/download?path=" + encodeURIComponent(currentTextItem.path) + "&token=" + authToken);
}

function prevMedia() {
  if (mediaItems.length <= 1) return;
  currentMediaIndex = (currentMediaIndex - 1 + mediaItems.length) % mediaItems.length;
  showMediaItem(currentMediaIndex);
}

function nextMedia() {
  if (mediaItems.length <= 1) return;
  currentMediaIndex = (currentMediaIndex + 1) % mediaItems.length;
  showMediaItem(currentMediaIndex);
}

function getExt(name) {
  return (name.split(".").pop() || "").toLowerCase();
}

function getFileIcon(name, isDir) {
  const ext = getExt(name);

  // Folder
  if (isDir) {
    return `<svg viewBox="0 0 24 24" fill="#fbbf24" stroke="#f59e0b" stroke-width="1">
      <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
    </svg>`;
  }

  // --- Images ---
  if (IMAGE_EXTS.has(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
    </svg>`;
  }

  // --- Video ---
  if (VIDEO_EXTS.has(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="1.5">
      <rect x="2" y="2" width="20" height="20" rx="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/>
    </svg>`;
  }

  // --- Audio ---
  if (AUDIO_EXTS.has(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="1.5">
      <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
    </svg>`;
  }

  // --- Archives ---
  if (ARCHIVE_EXTS.has(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="1.5">
      <path d="M21 8v13H3V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/>
    </svg>`;
  }

  // --- PDF ---
  if (ext === "pdf") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#ef4444" stroke="none" font-size="7" font-weight="bold" font-family="sans-serif">PDF</text>
    </svg>`;
  }

  // --- Word / Documents ---
  if (["doc","docx","odt","rtf"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#2563eb" stroke="none" font-size="6" font-weight="bold" font-family="sans-serif">DOC</text>
    </svg>`;
  }

  // --- Excel / Spreadsheets ---
  if (["xls","xlsx","ods"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#16a34a" stroke="none" font-size="6" font-weight="bold" font-family="sans-serif">XLS</text>
    </svg>`;
  }

  // --- PowerPoint / Presentations ---
  if (["ppt","pptx","odp"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#ea580c" stroke="none" font-size="6" font-weight="bold" font-family="sans-serif">PPT</text>
    </svg>`;
  }

  // --- Android APK ---
  if (ext === "apk") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#34d399" stroke="none" font-size="5.5" font-weight="bold" font-family="sans-serif">APK</text>
    </svg>`;
  }

  // --- Executables / Installers ---
  if (["exe","msi","dmg","app","deb","rpm","appimage"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="3"/>
      <circle cx="12" cy="11" r="3"/><path d="M12 14v3"/><path d="M9 8l3-3 3 3"/>
    </svg>`;
  }

  // --- Disk Images / ISO ---
  if (["iso","img","bin","vhd","vmdk"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="1.5">
      <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="6" stroke-dasharray="2 3"/>
    </svg>`;
  }

  // --- Fonts ---
  if (["ttf","otf","woff","woff2","eot"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="1.5">
      <path d="M4 7V4h16v3"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="8" y1="20" x2="16" y2="20"/>
    </svg>`;
  }

  // --- Data / Database ---
  if (["sql","db","sqlite","sqlite3","mdb"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5">
      <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/>
    </svg>`;
  }

  // --- JSON ---
  if (ext === "json") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#facc15" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#facc15" stroke="none" font-size="5" font-weight="bold" font-family="monospace">{}</text>
    </svg>`;
  }

  // --- XML / SVG / HTML markup ---
  if (["xml","svg","html","htm","xhtml"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#f97316" stroke="none" font-size="6" font-weight="bold" font-family="monospace">&lt;/&gt;</text>
    </svg>`;
  }

  // --- Markdown ---
  if (ext === "md" || ext === "mdx") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#64748b" stroke="none" font-size="8" font-weight="bold" font-family="sans-serif">M</text>
    </svg>`;
  }

  // --- YAML / Config files ---
  if (["yaml","yml","toml","ini","conf","cfg","env","properties","editorconfig"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <circle cx="9" cy="14" r="1" fill="#94a3b8" stroke="none"/><line x1="12" y1="14" x2="17" y2="14"/>
      <circle cx="9" cy="17.5" r="1" fill="#94a3b8" stroke="none"/><line x1="12" y1="17.5" x2="17" y2="17.5"/>
    </svg>`;
  }

  // --- CSV / TSV ---
  if (["csv","tsv"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="11" y1="11" x2="11" y2="19"/><line x1="14" y1="11" x2="14" y2="19"/>
    </svg>`;
  }

  // --- JavaScript / TypeScript ---
  if (["js","mjs","cjs"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#eab308" stroke="none" font-size="8" font-weight="bold" font-family="sans-serif">JS</text>
    </svg>`;
  }
  if (["ts","tsx"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#3b82f6" stroke="none" font-size="8" font-weight="bold" font-family="sans-serif">TS</text>
    </svg>`;
  }
  if (ext === "jsx") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#38bdf8" stroke="none" font-size="6" font-weight="bold" font-family="sans-serif">JSX</text>
    </svg>`;
  }

  // --- Python ---
  if (ext === "py" || ext === "pyw") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#3b82f6" stroke="none" font-size="7" font-weight="bold" font-family="sans-serif">PY</text>
    </svg>`;
  }

  // --- Java ---
  if (["java","jar","class"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17.5" text-anchor="middle" fill="#f97316" stroke="none" font-size="5.5" font-weight="bold" font-family="sans-serif">JAVA</text>
    </svg>`;
  }

  // --- C / C++ / C# ---
  if (["c","h"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16.5" text-anchor="middle" fill="#6366f1" stroke="none" font-size="10" font-weight="bold" font-family="sans-serif">C</text>
    </svg>`;
  }
  if (["cpp","cc","cxx","hpp","hxx"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#6366f1" stroke="none" font-size="7" font-weight="bold" font-family="sans-serif">C++</text>
    </svg>`;
  }
  if (ext === "cs") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#9333ea" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#9333ea" stroke="none" font-size="7.5" font-weight="bold" font-family="sans-serif">C#</text>
    </svg>`;
  }

  // --- Rust ---
  if (ext === "rs") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#f97316" stroke="none" font-size="7" font-weight="bold" font-family="sans-serif">RS</text>
    </svg>`;
  }

  // --- Go ---
  if (ext === "go") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#06b6d4" stroke="none" font-size="7" font-weight="bold" font-family="sans-serif">GO</text>
    </svg>`;
  }

  // --- Ruby ---
  if (["rb","erb","gemspec"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#dc2626" stroke="none" font-size="7" font-weight="bold" font-family="sans-serif">RB</text>
    </svg>`;
  }

  // --- PHP ---
  if (ext === "php") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#818cf8" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#818cf8" stroke="none" font-size="5.5" font-weight="bold" font-family="sans-serif">PHP</text>
    </svg>`;
  }

  // --- Swift ---
  if (ext === "swift") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16.5" text-anchor="middle" fill="#f97316" stroke="none" font-size="5" font-weight="bold" font-family="sans-serif">Swift</text>
    </svg>`;
  }

  // --- Kotlin ---
  if (["kt","kts"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#a855f7" stroke="none" font-size="8" font-weight="bold" font-family="sans-serif">KT</text>
    </svg>`;
  }

  // --- CSS / SCSS / LESS ---
  if (["css","scss","sass","less","styl"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <text x="12" y="17" text-anchor="middle" fill="#38bdf8" stroke="none" font-size="5.5" font-weight="bold" font-family="sans-serif">CSS</text>
    </svg>`;
  }

  // --- Shell scripts ---
  if (["sh","bash","zsh","fish","bat","ps1","cmd"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <polyline points="8 10 11 13 8 16"/><line x1="13" y1="16" x2="17" y2="16"/>
    </svg>`;
  }

  // --- Docker ---
  if (name.toLowerCase().startsWith("dockerfile") || ext === "dockerignore") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <text x="12" y="16" text-anchor="middle" fill="#38bdf8" stroke="none" font-size="5" font-weight="bold" font-family="monospace">DOCK</text>
    </svg>`;
  }

  // --- Makefile / Build files ---
  if (["makefile","cmake","gradle"].includes(ext) || name.toLowerCase() === "makefile") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#a3a3a3" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <circle cx="12" cy="15" r="3"/><path d="M12 12v-1"/><path d="M14.6 13.5l.8-.5"/><path d="M14.6 16.5l.8.5"/><path d="M12 18v1"/><path d="M9.4 16.5l-.8.5"/><path d="M9.4 13.5l-.8-.5"/>
    </svg>`;
  }

  // --- Git files ---
  if (["gitignore","gitmodules","gitattributes"].includes(ext) || name === ".gitignore") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="1.5">
      <circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="3.5"/><line x1="12" y1="2.5" x2="12" y2="5"/>
    </svg>`;
  }

  // --- Lock files / package management ---
  if (["lock","lockb"].includes(ext) || ["package-lock.json","yarn.lock","pnpm-lock.yaml","Gemfile.lock","composer.lock","Cargo.lock"].includes(name)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#a3a3a3" stroke-width="1.5">
      <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
    </svg>`;
  }

  // --- Log files ---
  if (ext === "log") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#78716c" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="16" x2="14" y2="16"/><line x1="8" y1="19" x2="12" y2="19"/>
    </svg>`;
  }

  // --- Text / Plain ---
  if (["txt","text","readme"].includes(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#71717a" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      <line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/>
    </svg>`;
  }

  // --- Torrent ---
  if (ext === "torrent") {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5">
      <path d="M12 2L2 19h20L12 2z"/><line x1="12" y1="9" x2="12" y2="13"/><circle cx="12" cy="16" r="0.5" fill="#22c55e"/>
    </svg>`;
  }

  // --- Catch-all: remaining CODE_EXTS ---
  if (CODE_EXTS.has(ext)) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="1.5">
      <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
    </svg>`;
  }

  // --- Default: unknown file ---
  return `<svg viewBox="0 0 24 24" fill="none" stroke="#71717a" stroke-width="1.5">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
  </svg>`;
}

function formatSize(bytes) {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(i > 0 ? 1 : 0) + " " + sizes[i];
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
}

function isImage(name) {
  return IMAGE_EXTS.has(getExt(name));
}

function toast(msg, type = "") {
  const el = document.createElement("div");
  el.className = "toast " + type;
  el.textContent = msg;
  document.getElementById("toasts").appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

let systemInfo = null;

async function loadSystemInfo() {
  try {
    const pathParam = currentPath ? `?path=${encodeURIComponent(currentPath)}` : "";
    const res = await fetch("/api/info" + pathParam, { headers: authHeaders() });
    if (!res.ok) return;
    systemInfo = await res.json();
    if (systemInfo.machine && systemInfo.machine.defaultDir) {
      defaultDir = systemInfo.machine.defaultDir;
    }
    updateSystemBar();
  } catch (err) {
    console.error("Failed to load system info:", err);
  }
}

function updateSystemBar() {
  if (!systemInfo) return;

  const { machine, disk } = systemInfo;

  document.getElementById("sysHostname").textContent = machine.hostname;
  document.getElementById("sysIp").textContent = machine.ipAddress;
  document.getElementById("sysUrl").textContent = `http://${machine.ipAddress}:${machine.port}`;
  updateSelectedPath();

  if (disk) {
    const usedGB = (disk.used / 1024 / 1024 / 1024).toFixed(1);
    const totalGB = (disk.total / 1024 / 1024 / 1024).toFixed(1);
    document.getElementById("sysDisk").textContent = `${usedGB} / ${totalGB} GB (${disk.percent}%)`;

    const fill = document.getElementById("diskFill");
    fill.style.width = disk.percent + "%";
    fill.classList.remove("warning", "danger");
    if (disk.percent > 90) fill.classList.add("danger");
    else if (disk.percent > 75) fill.classList.add("warning");
  }
}

function updateSelectedPath() {
  const selected = getSelectedItems();
  const el = document.getElementById("sysFilePath");

  if (selected.length === 1) {
    el.textContent = selected[0].path;
  } else if (selected.length > 1) {
    el.textContent = `${selected.length} files selected`;
  } else {
    el.textContent = currentPath || defaultDir;
  }
}

function toggleSystemBar() {
  const bar = document.getElementById("systemBar");
  bar.style.display = bar.style.display === "none" ? "flex" : "none";
  localStorage.setItem("showSystemBar", bar.style.display !== "none");
}

// Sidebar functions
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const backdrop = document.getElementById("sidebarBackdrop");
  sidebarCollapsed = !sidebarCollapsed;
  sidebar.classList.toggle("collapsed", sidebarCollapsed);
  backdrop.classList.toggle("visible", !sidebarCollapsed && window.innerWidth <= 768);
  localStorage.setItem("sidebarCollapsed", sidebarCollapsed);
}

async function loadDrives() {
  try {
    const res = await fetch("/api/drives", { headers: authHeaders() });
    if (!res.ok) return;
    drives = await res.json();
    renderDrives();
  } catch (err) {
    console.error("Failed to load drives:", err);
  }
}

function escapeHtml(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

function renderDrives() {
  const container = document.getElementById("drivesSection");
  container.innerHTML = drives.map(drive => {
    const usagePercent = Math.round((drive.used / drive.total) * 100);
    const isActive = currentPath === drive.path || currentPath.startsWith(drive.path + "/");
    const icon = drive.path === "/" ? "&#128187;" :
                 drive.name === "Home" ? "&#127968;" :
                 drive.name === "Shared" ? "&#128194;" : "&#128190;";
    const safePath = escapeHtml(drive.path);
    const safeName = escapeHtml(drive.name);
    return `
      <div class="drive-item${isActive ? ' active' : ''}" onclick="navigateAndExpandTree('${safePath}')">
        <div class="drive-icon">${icon}</div>
        <div class="drive-info">
          <div class="drive-name">${safeName}</div>
          <div class="drive-path">${safePath}</div>
          <div class="drive-usage">
            <div class="drive-usage-fill" style="width: ${usagePercent}%"></div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

async function loadTree(parentPath = "/") {
  try {
    const res = await fetch("/api/tree?path=" + encodeURIComponent(parentPath), { headers: authHeaders() });
    if (!res.ok) return [];
    return await res.json();
  } catch (err) {
    console.error("Failed to load tree:", err);
    return [];
  }
}

async function initTree() {
  const container = document.getElementById("treeSection");
  container.innerHTML = '<div class="tree-loading">Loading...</div>';

  // Start with the default dir or current path
  const startPath = currentPath || defaultDir;

  // Build initial tree from root
  let html = "";
  const rootFolders = await loadTree("/");

  for (const folder of rootFolders) {
    const isInPath = startPath === folder.path || startPath.startsWith(folder.path + "/");
    if (isInPath) {
      expandedPaths.add(folder.path);
    }
    html += await renderTreeItem(folder, isInPath);
  }

  container.innerHTML = html || '<div class="tree-loading">No folders</div>';

  // Highlight current path
  highlightTreePath(currentPath);
}

async function renderTreeItem(folder, autoExpand = false) {
  const isExpanded = expandedPaths.has(folder.path);
  const isActive = currentPath === folder.path;
  const expandClass = folder.hasChildren ? (isExpanded ? "expanded" : "") : "no-children";

  let childrenHtml = "";
  if (isExpanded && folder.hasChildren) {
    const children = await loadTree(folder.path);
    for (const child of children) {
      const isChildInPath = currentPath === child.path || currentPath.startsWith(child.path + "/");
      if (isChildInPath) {
        expandedPaths.add(child.path);
      }
      childrenHtml += await renderTreeItem(child, isChildInPath);
    }
  }

  const folderIcon = `<svg viewBox="0 0 24 24" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`;
  const chevronIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>`;
  const safePath = escapeHtml(folder.path);
  const safeName = escapeHtml(folder.name);

  return `
    <div class="tree-node" data-path="${safePath}">
      <div class="tree-item${isActive ? ' active' : ''}" data-path="${safePath}">
        <div class="tree-expand ${expandClass}" onclick="event.stopPropagation(); toggleTreeExpand('${safePath}')">${chevronIcon}</div>
        <div class="tree-icon">${folderIcon}</div>
        <div class="tree-name" onclick="navigate('${safePath}')">${safeName}</div>
      </div>
      <div class="tree-children${isExpanded ? ' expanded' : ''}" data-parent="${safePath}">
        ${childrenHtml}
      </div>
    </div>
  `;
}

async function toggleTreeExpand(folderPath) {
  const node = document.querySelector(`.tree-node[data-path="${CSS.escape(folderPath)}"]`);
  if (!node) return;

  const expandBtn = node.querySelector(":scope > .tree-item .tree-expand");
  const childrenContainer = node.querySelector(":scope > .tree-children");

  if (expandedPaths.has(folderPath)) {
    // Collapse
    expandedPaths.delete(folderPath);
    expandBtn.classList.remove("expanded");
    childrenContainer.classList.remove("expanded");
  } else {
    // Expand
    expandedPaths.add(folderPath);
    expandBtn.classList.add("expanded");
    childrenContainer.classList.add("expanded");

    // Load children if not already loaded
    if (childrenContainer.children.length === 0) {
      childrenContainer.innerHTML = '<div class="tree-loading">Loading...</div>';
      const children = await loadTree(folderPath);
      let html = "";
      for (const child of children) {
        html += await renderTreeItem(child, false);
      }
      childrenContainer.innerHTML = html || '<div class="tree-loading">Empty</div>';
    }
  }
}

function highlightTreePath(path) {
  // Remove previous active
  document.querySelectorAll(".tree-item.active").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".drive-item.active").forEach(el => el.classList.remove("active"));

  // Highlight current tree item
  if (path) {
    const treeItem = document.querySelector(`.tree-item[data-path="${CSS.escape(path)}"]`);
    if (treeItem) {
      treeItem.classList.add("active");
    }
  }

  // Highlight drive
  for (const drive of drives) {
    if (path === drive.path || path.startsWith(drive.path + "/")) {
      const driveItems = document.querySelectorAll(".drive-item");
      driveItems.forEach(el => {
        if (el.querySelector(".drive-path").textContent === drive.path) {
          el.classList.add("active");
        }
      });
      break;
    }
  }
}

async function navigateAndExpandTree(targetPath) {
  // Navigate to the path
  await navigate(targetPath);

  // Expand tree to show this path
  const pathParts = targetPath.split("/").filter(Boolean);
  let builtPath = "";

  for (let i = 0; i < pathParts.length; i++) {
    builtPath = "/" + pathParts.slice(0, i + 1).join("/");
    if (!expandedPaths.has(builtPath)) {
      await toggleTreeExpand(builtPath);
    }
  }

  highlightTreePath(targetPath);
}

function copyToClip(btn, text) {
  // Fallback method that works without HTTPS
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.style.position = "fixed";
  textarea.style.opacity = "0";
  document.body.appendChild(textarea);
  textarea.select();

  try {
    document.execCommand("copy");
    btn.classList.add("copied");
    toast("Copied to clipboard", "success");
    setTimeout(() => btn.classList.remove("copied"), 1500);
  } catch (err) {
    toast("Failed to copy", "error");
  }

  document.body.removeChild(textarea);
}

async function navigate(path, { pushHistory = true } = {}) {
  currentPath = path || defaultDir;

  // Push browser history state so back/forward buttons navigate folders
  if (pushHistory) {
    history.pushState({ path: currentPath }, "", "#" + encodeURIComponent(currentPath));
  }

  updateBreadcrumb();
  updateFullPath();
  updateSelectedPath();
  highlightTreePath(currentPath);
  document.getElementById("dropPath").textContent = currentPath;
  document.getElementById("searchInput").value = "";
  searchQuery = "";
  document.getElementById("clearSearch").classList.remove("visible");
  clearSelection();

  // Show loading skeletons
  showLoadingSkeletons();

  try {
    const res = await fetch("/api/list?path=" + encodeURIComponent(currentPath), {
      headers: authHeaders()
    });
    if (res.status === 401) {
      authToken = "";
      localStorage.removeItem("authToken");
      checkAuth();
      return;
    }
    currentItems = await res.json();
    applyFilterAndSort();
  } catch (err) {
    toast("Failed to load directory", "error");
    document.getElementById("fileGrid").textContent = "";
  }
}

// Browser back/forward button navigates folders
window.addEventListener("popstate", (e) => {
  if (e.state && e.state.path) {
    navigate(e.state.path, { pushHistory: false });
  }
});

function showLoadingSkeletons() {
  const grid = document.getElementById("fileGrid");
  const empty = document.getElementById("emptyState");
  empty.style.display = "none";

  let skeletons = "";
  for (let i = 0; i < 8; i++) {
    skeletons += `
      <div class="skeleton-item">
        <div class="skeleton-preview skeleton"></div>
        <div class="skeleton-info">
          <div class="skeleton-name skeleton"></div>
          <div class="skeleton-meta skeleton"></div>
        </div>
      </div>
    `;
  }
  grid.innerHTML = skeletons;
}

function updateFullPath() {
  document.getElementById("fullPath").textContent = currentPath || defaultDir;
}

function copyPath() {
  const fullPath = document.getElementById("fullPath").textContent;
  const btn = document.getElementById("copyPathBtn");

  // Fallback method that works without HTTPS
  const textarea = document.createElement("textarea");
  textarea.value = fullPath;
  textarea.style.position = "fixed";
  textarea.style.opacity = "0";
  document.body.appendChild(textarea);
  textarea.select();

  try {
    document.execCommand("copy");
    btn.classList.add("copied");
    btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      Copied!
    `;
    toast("Copied: " + fullPath, "success");
    setTimeout(() => {
      btn.classList.remove("copied");
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        </svg>
        Copy
      `;
    }, 2000);
  } catch (err) {
    toast("Failed to copy", "error");
  }

  document.body.removeChild(textarea);
}

function updateBreadcrumb() {
  const bc = document.getElementById("breadcrumb");
  const path = currentPath || defaultDir;
  const parts = path.split("/").filter(Boolean);
  let html = '<a onclick="navigate(\'/\')">/ root</a>';
  let accumulated = "";
  for (const part of parts) {
    accumulated += "/" + part;
    const safePath = escapeHtml(accumulated);
    const safePart = escapeHtml(part);
    html += '<span class="sep">/</span>';
    html += `<a onclick="navigate('${safePath}')">${safePart}</a>`;
  }
  bc.innerHTML = html;
}

function renderGrid(items) {
  const grid = document.getElementById("fileGrid");
  const empty = document.getElementById("emptyState");

  if (items.length === 0) {
    grid.innerHTML = "";
    empty.style.display = searchQuery ? "none" : "block";
    if (searchQuery) {
      grid.innerHTML = '<div class="empty"><div class="icon">&#128269;</div><p>No files match your search</p></div>';
    }
    return;
  }
  empty.style.display = "none";

  grid.innerHTML = items.map((item, index) => {
    // Remove leading slash from absolute path for URL construction
    const urlPath = item.path.startsWith('/') ? item.path.slice(1) : item.path;
    const imgUrl = `/files/${encodeURIComponent(urlPath).replace(/%2F/g, '/')}?token=${authToken}`;
    const preview = item.isDirectory
      ? `<div class="icon-large">${getFileIcon(item.name, true)}</div>`
      : isImage(item.name)
        ? `<img src="${imgUrl}" loading="lazy" alt="${item.name}">`
        : `<div class="icon-large">${getFileIcon(item.name, false)}</div>`;

    const isSelected = selectedPaths.has(item.path);
    const checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg>';
    const draggable = !item.isDirectory ? 'draggable="true"' : '';
    const dropTarget = item.isDirectory ? 'ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleFileDrop(event, ' + index + ')"' : '';
    return `
      <div class="file-item${isSelected ? ' selected' : ''}"
           data-index="${index}"
           data-path="${item.path}"
           data-isdir="${item.isDirectory}"
           ${draggable}
           ondragstart="handleDragStart(event, ${index})"
           ondragend="handleDragEnd(event)"
           ${dropTarget}
           onclick="handleClick(event, ${index})"
           oncontextmenu="showContext(event, ${index})">
        <div class="checkbox" onclick="event.stopPropagation(); toggleSelect(${index}, event)">${checkSvg}</div>
        <div class="preview${item.isDirectory ? ' folder-preview' : ''}">${preview}</div>
        <div class="info">
          <div class="name" title="${item.name}">${item.name}</div>
          <div class="meta">${item.isDirectory ? "Folder" : formatSize(item.size)} &middot; ${formatDate(item.modified)}</div>
        </div>
      </div>
    `;
  }).join("");
}

// Drag to move functionality
function handleDragStart(event, index) {
  const item = filteredItems[index];
  if (!item || item.isDirectory) {
    event.preventDefault();
    return;
  }
  draggedItem = item;
  event.target.classList.add("dragging");
  event.dataTransfer.effectAllowed = "move";
  event.dataTransfer.setData("text/plain", item.path);
}

function handleDragEnd(event) {
  event.target.classList.remove("dragging");
  document.querySelectorAll(".file-item.drag-over").forEach(el => el.classList.remove("drag-over"));
  draggedItem = null;
}

function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = "move";
  const target = event.target.closest(".file-item");
  if (target && target.dataset.isdir === "true") {
    target.classList.add("drag-over");
  }
}

function handleDragLeave(event) {
  const target = event.target.closest(".file-item");
  if (target) {
    target.classList.remove("drag-over");
  }
}

async function handleFileDrop(event, targetIndex) {
  event.preventDefault();
  event.stopPropagation();

  const target = event.target.closest(".file-item");
  if (target) target.classList.remove("drag-over");

  const targetItem = filteredItems[targetIndex];
  if (!targetItem || !targetItem.isDirectory || !draggedItem) return;

  const sourcePath = draggedItem.path;
  const fileName = draggedItem.name;
  const destPath = targetItem.path + "/" + fileName;

  try {
    const res = await fetch("/api/move", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ sourcePath, destPath })
    });

    if (res.ok) {
      toast(`Moved "${fileName}" to "${targetItem.name}"`, "success");
      navigate(currentPath);
    } else {
      const err = await res.json();
      toast(err.error || "Move failed", "error");
    }
  } catch {
    toast("Move failed", "error");
  }

  draggedItem = null;
}

function handleClick(event, index) {
  const item = filteredItems[index];
  if (!item) return;

  // Check for modifier keys for selection
  if (event.ctrlKey || event.metaKey) {
    toggleSelect(index, event);
    return;
  }

  if (event.shiftKey && lastSelectedIndex !== -1) {
    selectRange(lastSelectedIndex, index);
    return;
  }

  // Normal click - if no selection, do default action; if has selection, just select this one
  if (selectedPaths.size > 0) {
    clearSelection();
    toggleSelect(index, event);
    return;
  }

  // Default actions
  if (item.isDirectory) {
    navigate(item.path);
  } else if (isMedia(item.name)) {
    openMedia(index);
  } else if (isTextFile(item.name)) {
    openTextPreview(index);
  } else {
    window.open("/api/download?path=" + encodeURIComponent(item.path) + "&token=" + authToken);
  }
}

function toggleSelect(index, event) {
  const item = filteredItems[index];
  if (!item) return;

  if (event && event.shiftKey && lastSelectedIndex !== -1) {
    selectRange(lastSelectedIndex, index);
    return;
  }

  const el = document.querySelector(`.file-item[data-index="${index}"]`);
  if (selectedPaths.has(item.path)) {
    selectedPaths.delete(item.path);
    if (el) el.classList.remove("selected");
  } else {
    selectedPaths.add(item.path);
    if (el) el.classList.add("selected");
    lastSelectedIndex = index;
  }
  updateSelectionUI();
}

function selectRange(startIndex, endIndex) {
  const min = Math.min(startIndex, endIndex);
  const max = Math.max(startIndex, endIndex);
  for (let i = min; i <= max; i++) {
    const item = filteredItems[i];
    if (item && !selectedPaths.has(item.path)) {
      selectedPaths.add(item.path);
      const el = document.querySelector(`.file-item[data-index="${i}"]`);
      if (el) el.classList.add("selected");
    }
  }
  lastSelectedIndex = endIndex;
  updateSelectionUI();
}

function selectAll() {
  filteredItems.forEach((item, index) => {
    if (!selectedPaths.has(item.path)) {
      selectedPaths.add(item.path);
      const el = document.querySelector(`.file-item[data-index="${index}"]`);
      if (el) el.classList.add("selected");
    }
  });
  if (filteredItems.length > 0) lastSelectedIndex = filteredItems.length - 1;
  updateSelectionUI();
}

function clearSelection() {
  selectedPaths.clear();
  lastSelectedIndex = -1;
  document.querySelectorAll(".file-item.selected").forEach(el => {
    el.classList.remove("selected");
  });
  updateSelectionUI();
}

function updateSelectionUI() {
  const count = selectedPaths.size;
  const bar = document.getElementById("selectionBar");
  const grid = document.getElementById("fileGrid");
  document.getElementById("selectionCount").textContent = count;
  if (count > 0) {
    bar.classList.add("visible");
    grid.classList.add("has-selection");
  } else {
    bar.classList.remove("visible");
    grid.classList.remove("has-selection");
  }
  updateSelectedPath();
}

function getSelectedItems() {
  return filteredItems.filter(item => selectedPaths.has(item.path));
}

function showContext(event, index) {
  event.preventDefault();
  const item = filteredItems[index];
  if (!item) return;

  // If right-clicking on unselected item, select only that item
  if (!selectedPaths.has(item.path)) {
    clearSelection();
    selectedPaths.add(item.path);
    lastSelectedIndex = index;
    const el = document.querySelector(`.file-item[data-index="${index}"]`);
    if (el) el.classList.add("selected");
    updateSelectionUI();
  }

  contextTarget = item;

  // Update context menu labels based on selection count
  const count = selectedPaths.size;
  const ctxDownload = document.getElementById("ctxDownload");
  const ctxRename = document.getElementById("ctxRename");
  const ctxDelete = document.getElementById("ctxDelete");
  const ctxCopyPath = document.getElementById("ctxCopyPath");

  if (count > 1) {
    ctxDownload.querySelector("span").textContent = `Download ${count} items`;
    ctxRename.style.display = "none";
    ctxCopyPath.style.display = "none";
    ctxDelete.querySelector("span").textContent = `Delete ${count} items`;
  } else {
    ctxDownload.querySelector("span").textContent = "Download";
    ctxRename.style.display = "flex";
    ctxCopyPath.style.display = "flex";
    ctxDelete.querySelector("span").textContent = "Delete";
  }

  const menu = document.getElementById("contextMenu");
  menu.classList.add("visible");
  const menuW = menu.offsetWidth;
  const menuH = menu.offsetHeight;
  const x = Math.min(event.clientX, window.innerWidth - menuW - 8);
  const y = Math.min(event.clientY, window.innerHeight - menuH - 8);
  menu.style.left = Math.max(0, x) + "px";
  menu.style.top = Math.max(0, y) + "px";
}

document.addEventListener("click", (e) => {
  document.getElementById("contextMenu").classList.remove("visible");
});

// Clear selection when clicking on empty grid space
document.getElementById("fileGrid").addEventListener("click", (e) => {
  if (e.target.id === "fileGrid") {
    clearSelection();
  }
});

function copyItemPath() {
  if (!contextTarget) return;
  const fullPath = contextTarget.path;
  const textarea = document.createElement("textarea");
  textarea.value = fullPath;
  textarea.style.position = "fixed";
  textarea.style.opacity = "0";
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand("copy");
    toast("Copied: " + fullPath, "success");
  } catch {
    toast("Failed to copy path", "error");
  }
  document.body.removeChild(textarea);
  document.getElementById("contextMenu").classList.remove("visible");
}

function renameItem() {
  if (!contextTarget) return;
  document.getElementById("renameInput").value = contextTarget.name;
  document.getElementById("renameModal").classList.add("visible");
  setTimeout(() => document.getElementById("renameInput").focus(), 50);
}

async function confirmRename() {
  const newName = document.getElementById("renameInput").value.trim();
  if (!newName || !contextTarget) return;
  try {
    await fetch("/api/rename", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ oldPath: contextTarget.path, newName }),
    });
    toast("Renamed to " + newName, "success");
    closeModal("renameModal");
    navigate(currentPath);
  } catch {
    toast("Rename failed", "error");
  }
}

function deleteItem() {
  // If multiple items selected, delete all selected
  if (selectedPaths.size > 1) {
    deleteSelected();
    return;
  }
  if (!contextTarget) return;
  if (!confirm(`Delete "${contextTarget.name}"? This cannot be undone.`)) return;
  fetch("/api/delete", {
    method: "DELETE",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ path: contextTarget.path }),
  }).then(() => {
    toast("Deleted " + contextTarget.name, "success");
    navigate(currentPath);
  }).catch(() => toast("Delete failed", "error"));
}

async function deleteSelected() {
  const selected = getSelectedItems();
  if (selected.length === 0) return;

  const msg = selected.length === 1
    ? `Delete "${selected[0].name}"?`
    : `Delete ${selected.length} items?`;
  if (!confirm(msg + " This cannot be undone.")) return;

  let successCount = 0;
  let failCount = 0;

  for (const item of selected) {
    try {
      const res = await fetch("/api/delete", {
        method: "DELETE",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ path: item.path }),
      });
      if (res.ok) successCount++;
      else failCount++;
    } catch {
      failCount++;
    }
  }

  if (successCount > 0) {
    toast(`Deleted ${successCount} item(s)`, "success");
  }
  if (failCount > 0) {
    toast(`Failed to delete ${failCount} item(s)`, "error");
  }
  navigate(currentPath);
}

function downloadItem() {
  // If multiple items selected, download all selected
  if (selectedPaths.size > 1) {
    downloadSelected();
    return;
  }
  if (!contextTarget) return;
  window.open("/api/download?path=" + encodeURIComponent(contextTarget.path) + "&token=" + authToken);
}

function downloadSelected() {
  const selected = getSelectedItems();
  if (selected.length === 0) return;

  // Filter out directories for individual downloads (folders can't be downloaded directly)
  const files = selected.filter(item => !item.isDirectory);
  if (files.length === 0) {
    toast("No files selected (folders cannot be downloaded)", "error");
    return;
  }

  // Download each file
  files.forEach((item, i) => {
    // Stagger downloads slightly to avoid browser blocking
    setTimeout(() => {
      const a = document.createElement("a");
      a.href = "/api/download?path=" + encodeURIComponent(item.path) + "&token=" + authToken;
      a.download = item.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }, i * 200);
  });

  toast(`Downloading ${files.length} file(s)`, "success");
}

function createFolder() {
  document.getElementById("folderInput").value = "";
  document.getElementById("folderModal").classList.add("visible");
  setTimeout(() => document.getElementById("folderInput").focus(), 50);
}

async function confirmFolder() {
  const name = document.getElementById("folderInput").value.trim();
  if (!name) return;
  try {
    await fetch("/api/mkdir", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ path: currentPath, name }),
    });
    toast("Created folder: " + name, "success");
    closeModal("folderModal");
    navigate(currentPath);
  } catch {
    toast("Failed to create folder", "error");
  }
}

function closeModal(id) {
  document.getElementById(id).classList.remove("visible");
}

// Close modals on overlay click
document.querySelectorAll(".modal-overlay").forEach(el => {
  el.addEventListener("click", e => {
    if (e.target === el) el.classList.remove("visible");
  });
});

// Drag & drop
function handleDrop(event) {
  event.preventDefault();
  document.getElementById("dropzone").classList.remove("active");
  const files = event.dataTransfer.files;
  if (files.length) uploadFiles(files);
}

async function uploadFiles(files) {
  if (!files.length) return;
  const bar = document.getElementById("uploadBar");
  const label = document.getElementById("uploadLabel");
  const progress = document.getElementById("uploadProgress");

  bar.classList.add("visible");
  label.textContent = `Uploading ${files.length} file(s)...`;
  progress.style.width = "0%";

  const formData = new FormData();
  for (const f of files) formData.append("files", f);

  try {
    const xhr = new XMLHttpRequest();
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        progress.style.width = pct + "%";
        label.textContent = `Uploading ${files.length} file(s)... ${pct}%`;
      }
    };
    xhr.onload = () => {
      toast(`Uploaded ${files.length} file(s)`, "success");
      bar.classList.remove("visible");
      navigate(currentPath);
      document.getElementById("fileInput").value = "";
    };
    xhr.onerror = () => {
      toast("Upload failed", "error");
      bar.classList.remove("visible");
    };
    xhr.open("POST", "/api/upload?path=" + encodeURIComponent(currentPath));
    xhr.setRequestHeader("X-Auth-Token", authToken);
    xhr.send(formData);
  } catch {
    toast("Upload failed", "error");
    bar.classList.remove("visible");
  }
}

// Full page drag & drop
document.addEventListener("dragover", e => {
  e.preventDefault();
  document.getElementById("dropzone").classList.add("active");
});
document.addEventListener("dragleave", e => {
  if (!e.relatedTarget) document.getElementById("dropzone").classList.remove("active");
});
document.addEventListener("drop", e => {
  e.preventDefault();
  document.getElementById("dropzone").classList.remove("active");
  if (e.target.closest(".dropzone") || e.target.closest(".file-grid")) {
    const files = e.dataTransfer.files;
    if (files.length) uploadFiles(files);
  }
});

// Keyboard shortcuts
document.addEventListener("keydown", e => {
  // Don't trigger shortcuts when typing in inputs
  if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;

  const mediaOverlay = document.getElementById("mediaOverlay");
  const mediaOpen = mediaOverlay.classList.contains("visible");

  // Media overlay navigation
  if (mediaOpen) {
    if (e.key === "Escape") {
      closeMedia();
      return;
    }
    if (e.key === "ArrowLeft") {
      e.preventDefault();
      prevMedia();
      return;
    }
    if (e.key === "ArrowRight") {
      e.preventDefault();
      nextMedia();
      return;
    }
    return; // Don't process other shortcuts when media is open
  }

  if (e.key === "Escape") {
    document.querySelectorAll(".modal-overlay").forEach(el => el.classList.remove("visible"));
    if (searchQuery) {
      clearSearch();
    } else {
      clearSelection();
    }
  }

  // Ctrl+A or Cmd+A to select all
  if ((e.ctrlKey || e.metaKey) && e.key === "a") {
    e.preventDefault();
    selectAll();
  }

  // Ctrl+F or / to focus search
  if (((e.ctrlKey || e.metaKey) && e.key === "f") || e.key === "/") {
    e.preventDefault();
    document.getElementById("searchInput").focus();
  }

  // Delete or Backspace to delete selected
  if ((e.key === "Delete" || e.key === "Backspace") && selectedPaths.size > 0) {
    e.preventDefault();
    deleteSelected();
  }
});

// App initialization
async function initApp() {
  // Restore theme from localStorage
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "light") {
    isDarkTheme = false;
    document.body.classList.add("light-theme");
    updateThemeIcon();
  }

  // Restore system bar state from localStorage
  const showBar = localStorage.getItem("showSystemBar");
  if (showBar === "false") {
    document.getElementById("systemBar").style.display = "none";
  }

  // Restore sidebar state
  if (sidebarCollapsed) {
    document.getElementById("sidebar").classList.add("collapsed");
  }

  // Load system info first to get defaultDir
  await loadSystemInfo();

  // Load drives and tree
  await loadDrives();
  await initTree();

  // Set initial history state and navigate to default directory
  history.replaceState({ path: defaultDir }, "", "#" + encodeURIComponent(defaultDir));
  navigate(defaultDir, { pushHistory: false });
}

// Startup: check setup status, then auth
(async function startup() {
  const needsSetup = await checkSetupNeeded();
  if (needsSetup) {
    // Show setup overlay, hide auth
    document.getElementById("setupOverlay").classList.remove("hidden");
    document.getElementById("authOverlay").classList.add("hidden");
    document.getElementById("setupPassword").focus();
  } else {
    // Hide setup overlay, check auth
    document.getElementById("setupOverlay").classList.add("hidden");
    if (checkAuth()) {
      initApp();
    }
  }
})();
</script>
</body>
</html>
