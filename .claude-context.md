# File Share - Project Context

## Overview
A local network file sharing application built with Node.js/Express backend and vanilla HTML/CSS/JS frontend. Serves files from a configurable shared directory with password protection and first-run browser-based setup.

## Tech Stack
- **Backend**: Node.js, Express, Multer (file uploads)
- **Frontend**: Vanilla HTML/CSS/JS (single-page app in `public/index.html`)
- **Auth**: Password hashed with SHA-256 + random salt, HMAC-based tokens with optional expiry
- **Config**: `data/config.json` (auto-generated on first run or via env vars)

## Key Files
- `server.js` - Express server, all API endpoints, config system
- `public/index.html` - Complete SPA with embedded CSS and JS
- `data/config.json` - Persisted configuration (gitignored)
- `docker-compose.yml` - Docker Compose with optional Caddy HTTPS profile
- `Caddyfile.standalone` - Caddy config for standalone HTTPS deployment

## Configuration
- **First run**: Browser shows setup screen to pick password, shared dir, and filesystem toggle
- **Normal use**: Login screen, then file browser
- **Docker/headless**: Set `PASSWORD`, `SHARED_DIR`, `ALLOW_FULL_FILESYSTEM` env vars
- **Priority**: ENV vars > `data/config.json` > defaults (port 4040, ~/shared, no full fs)

## Features
- File browsing with grid view
- Multi-select with Shift/Ctrl click support
- Upload files (drag & drop or click)
- Create, rename, delete files/folders
- Download files (single and batch)
- Move files by dragging onto folders
- Search and sort (by name, date, size)
- Password protection with hashed storage
- System info bar (hostname, IP, disk usage, selected path)
- Media preview (images, video, audio) with gallery navigation
- Dark/light theme toggle
- Loading skeletons during navigation
- Responsive design
- Sidebar with drives list and folder tree navigation
- Full filesystem browsing (configurable)
- Browser back/forward button navigation (History API integration)
- Dockerfile for containerization
- Docker Compose with optional Caddy HTTPS reverse proxy (`--profile https`)
- Settings panel to change shared directory, filesystem access, and password after setup
- Configurable session expiry (never / 1 day / 7 days / 30 days) in setup and settings
- Rate limiting on auth and setup endpoints (5 attempts/minute/IP)
- HMAC-based auth tokens with time-stamped issuance and optional expiry
- Inline SVG favicon

### API Endpoints
- `GET /api/status` - Check if setup is needed (unauthenticated)
- `POST /api/setup` - First-run configuration (unauthenticated, one-time)
- `POST /api/auth` - Authenticate with password
- `GET /api/settings` - Get current settings (sharedDir, allowFullFilesystem, tokenExpiryMs)
- `POST /api/settings` - Update settings (requires currentPassword; can change sharedDir, allowFullFilesystem, password, tokenExpiryMs)
- `GET /api/info` - System info (hostname, IP, disk usage)
- `GET /api/list` - List directory contents
- `GET /api/drives` - List mounted drives/volumes
- `GET /api/tree` - Get folder tree for sidebar
- `POST /api/upload` - Upload files
- `POST /api/mkdir` - Create folder
- `POST /api/rename` - Rename file/folder
- `POST /api/move` - Move file to folder
- `DELETE /api/delete` - Delete file/folder
- `GET /api/download` - Download file
- `GET /files/*` - Serve files for previews

## Running
```bash
node server.js
# Access at http://localhost:4040
# First run shows setup screen in browser
```

## Docker
```bash
# Build and run directly
docker build -t file-share .
docker run -p 4040:4040 -v ./data:/app/data -e PASSWORD=yourpass file-share

# Docker Compose (app only)
docker compose up -d

# Docker Compose with Caddy HTTPS
docker compose --profile https up -d
```

## Session Log

### 2026-01-26
- Built complete file sharing application
- Added multi-select, search/sort, password protection
- Added media gallery, drag-to-move, theme toggle, loading skeletons

### 2026-01-27
- Added browser back/forward button support using History API
- Stripped hardcoded personal data (password, paths, port)
- Added first-run setup screen with browser-based onboarding
- Config persists in `data/config.json` with ENV var overrides
- Password stored as SHA-256 hash with random per-install salt

### 2026-01-27 (session 2)
- Added settings panel (gear button in header) with modal UI
  - Change shared directory, filesystem toggle, and password post-setup
  - Requires current password to save any changes
  - Auto-refreshes auth token, sidebar, and file listing on save
- Added `GET /api/settings` and `POST /api/settings` endpoints
- Fixed settings error text showing "Error" on open (was using `.auth-error` class outside `.auth-box`)
- Reordered settings password fields: current password first, then new + confirm
- Added confirm password field to onboarding setup wizard with mismatch validation

### 2026-01-27 (session 3)
- Added rate limiting on `/api/auth` and `/api/setup` (5 attempts/minute/IP, in-memory)
- Replaced static auth token with HMAC-SHA256 time-stamped tokens
- Added configurable session expiry (never/1d/7d/30d) to setup wizard and settings panel
- Added inline SVG favicon (blue folder icon)
- Added `docker-compose.yml` with optional Caddy HTTPS profile
- Added `Caddyfile.standalone` for standalone HTTPS deployment
- Docker end-to-end tested: build, setup flow, auth, rate limiting, settings
